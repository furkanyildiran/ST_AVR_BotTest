#include "pcd8544.h"
#define COMMAND 1
#define DATA 0
#define CE_PIN_LOW()    do{*PCD_port_addr &= ~(1 << CE_PIN); asm volatile("NOP\n\tNOP\n\t"::);}while(0)
#define CE_PIN_HIGH()   do{*PCD_port_addr |=  (1 << CE_PIN); asm volatile("NOP\n\t""NOP\n\t"::);}while(0)
#define RST_PIN_LOW()   do{*PCD_port_addr &= ~(1 << RST_PIN);}while(0)
#define RST_PIN_HIGH()  do{*PCD_port_addr |=  (1 << RST_PIN);}while(0)
#define DC_PIN_COMMAD() do{*PCD_port_addr &= ~(1 << DC_PIN); asm volatile("NOP\n\tNOP\n\t"::);}while(0)
#define DC_PIN_DATA()   do{*PCD_port_addr |=  (1 << DC_PIN); asm volatile("NOP\n\tNOP\n\t"::);}while(0)

const uint8_t characters[CHAR_NUMBER][CHAR_WIDTH] PROGMEM ={
	{0x00,0x00,0x00,0x00,0x00},//space
	{0x00,0x00,0x5f,0x00,0x00},//!
	{0x00,0x00,0x07,0x00,0x07},//"
	{0x14,0x7f,0x14,0x7f,0x14},//#
	{0x24,0x2a,0x7f,0x2a,0x12},//$
	{0x23,0x13,0x08,0x64,0x62},//%
	{0x36,0x49,0x55,0x22,0x50},//&
	{0x00,0x00,0x05,0x03,0x00},//'
	{0x00,0x1c,0x22,0x41,0x00},//(
	{0x00,0x41,0x22,0x1c,0x00},//)
	{0x14,0x08,0x3e,0x08,0x14},//*
	{0x08,0x08,0x3e,0x08,0x08},//+
	{0x00,0x00,0x00,0x50,0x30},//,
	{0x08,0x08,0x08,0x08,0x08},//-
	{0x00,0x00,0x30,0x30,0x00},//.
	{0x20,0x10,0x08,0x04,0x02},//slash
	{0x3e,0x51,0x49,0x45,0x3e},//0
	{0x00,0x42,0x7f,0x40,0x00},//1
	{0x40,0x66,0x51,0x49,0x46},//2
	{0x22,0x41,0x49,0x49,0x36},//3
	{0x18,0x14,0x12,0x7f,0x10},//4
	{0x27,0x45,0x45,0x45,0x39},//5
	{0x3c,0x4a,0x49,0x49,0x31},//6
	{0x01,0x71,0x09,0x05,0x03},//7
	{0x36,0x49,0x49,0x49,0x36},//8
	{0x26,0x49,0x49,0x49,0x3e},//9
	{0x00,0x00,0x33,0x33,0x00},//:
	{0x00,0x00,0x00,0x56,0x36},//;
	{0x00,0x08,0x14,0x22,0x00},//<
	{0x00,0x14,0x14,0x14,0x00},//=
	{0x00,0x22,0x14,0x08,0x00},//>
	{0x02,0x01,0x51,0x09,0x06},//?
	{0x32,0x49,0x49,0x51,0x3e},//@
	{0x7e,0x09,0x09,0x09,0x7e},//A
	{0x7f,0x49,0x49,0x49,0x36},//B
	{0x3e,0x41,0x41,0x41,0x22},//C
	{0x7f,0x41,0x41,0x22,0x1c},//D
	{0x7f,0x49,0x49,0x49,0x41},//E
	{0x7f,0x09,0x09,0x09,0x01},//F
	{0x3e,0x41,0x49,0x49,0x3a},//G
	{0x7f,0x08,0x08,0x08,0x7f},//H
	{0x41,0x41,0x7f,0x41,0x41},//I
	{0x20,0x40,0x41,0x3f,0x01},//J
	{0x7f,0x18,0x14,0x22,0x41},//K
	{0x7f,0x40,0x40,0x40,0x40},//L
	{0x7f,0x02,0x0c,0x02,0x7f},//M
	{0x7f,0x02,0x04,0x18,0x7f},//N
	{0x3e,0x41,0x41,0x41,0x3e},//O
	{0x7f,0x09,0x09,0x09,0x06},//P
	{0x3E,0x41,0x51,0x21,0xde},//Q
	{0x7f,0x19,0x29,0x49,0x46},//R
	{0x46,0x49,0x49,0x49,0x31},//S
	{0x01,0x01,0x7f,0x01,0x01},//T
	{0x3f,0x40,0x40,0x40,0x3f},//U
	{0x1f,0x30,0x40,0x30,0x1f},//V
	{0x3f,0x40,0x38,0x40,0x3f},//W
	{0x63,0x14,0x08,0x14,0x63},//X
	{0x03,0x04,0x78,0x04,0x03},//Y
	{0x61,0x51,0x49,0x45,0x43},//Z
	{0x00,0x7F,0x41,0x41,0x00},//[
	{0x02,0x04,0x08,0x10,0x20},//backslash
	{0x00,0x41,0x41,0x7F,0x00},//]
	{0x10,0x08,0x04,0x08,0x10},//^
	{0x00,0x40,0x40,0x40,0x40},//_
	{0x00,0x03,0x05,0x00,0x00},//`
	{0x20,0x54,0x54,0x54,0x78},//a
	{0x7f,0x48,0x44,0x44,0x38},//b
	{0x38,0x44,0x44,0x44,0x20},//c
	{0x38,0x44,0x44,0x48,0x7f},//d
	{0x38,0x54,0x54,0x54,0x18},//e
	{0x08,0x7e,0x09,0x01,0x02},//f
	{0x18,0xa4,0xa4,0xa4,0x7c},//g
	{0x7f,0x08,0x04,0x04,0x78},//h
	{0x00,0x44,0x7d,0x40,0x00},//i
	{0x00,0x40,0x80,0x84,0x7d},//j
	{0x00,0x7f,0x10,0x28,0x44},//k
	{0x00,0x41,0x7f,0x40,0x00},//l
	{0x7c,0x04,0x18,0x04,0x78},//m
	{0x7c,0x08,0x04,0x04,0x78},//n
	{0x38,0x44,0x44,0x44,0x38},//o
	{0xfc,0x18,0x24,0x24,0x18},//p
	{0x18,0x24,0x24,0x18,0xfc},//q
	{0x7c,0x08,0x04,0x04,0x08},//r
	{0x48,0x54,0x54,0x54,0x20},//s
	{0x04,0x3f,0x44,0x40,0x20},//t
	{0x3c,0x40,0x40,0x20,0x7c},//u
	{0x1c,0x20,0x40,0x20,0x1c},//w
	{0x3c,0x40,0x30,0x40,0x3c},//v
	{0x44,0x28,0x10,0x28,0x44},//y
	{0x1c,0xa0,0xa0,0xa0,0x7c},//z
	{0x44,0x64,0x54,0x4c,0x44} //x
};

static uint8_t DC_PIN = 0, RST_PIN = 0, CE_PIN = 0;
static volatile uint8_t *PCD_port_addr;

static __attribute__((always_inline)) void reset(void);
static void send_command(uint8_t command);
static void send_data(uint8_t data);

static __attribute__((always_inline)) inline void reset(void){
	RST_PIN_LOW();
	_delay_ms(res_low_pulse_width);
	RST_PIN_HIGH();
}

static void send_command(uint8_t command){
	CE_PIN_LOW();
	DC_PIN_COMMAD();
	SPI_transaction(command);
	CE_PIN_HIGH();
}
static void send_data(uint8_t data){
	CE_PIN_LOW();
	DC_PIN_DATA();
	SPI_transaction(data);
	CE_PIN_HIGH();
}
void PCD_init(volatile uint8_t *const port_addr, uint8_t dc_pin, uint8_t rst_pin, uint8_t ce_pin){
	DC_PIN = dc_pin;
	RST_PIN = rst_pin;
	CE_PIN = ce_pin;
	PCD_port_addr = port_addr;
	volatile uint8_t *const DDR_ADDR = (PCD_port_addr + GPIO_DDR_ADDR_OFFSET);
	*DDR_ADDR |= (1 << RST_PIN) | (1 << DC_PIN) | (1 << CE_PIN);
	CE_PIN_HIGH();
	reset();
	_delay_ms(10);
	send_command(func_set(CHIP_ACTIVE, VERTICL_ADDR, EXTND_I_SET));
	send_command(temp_ctrl(TEMP_COEFF1));
	send_command(bias_systm(BIAS4));
	send_command(set_Vop(60));
	send_command(func_set(CHIP_ACTIVE, VERTICL_ADDR, BASIC_I_SET));
	send_command(dsply_ctrl(NORMAL_MODE));
}

void PCD_contrast(uint8_t contrast){
	if(contrast > 70)
	  contrast = 70;
	send_command(func_set(CHIP_ACTIVE, HORZNTL_ADDR, EXTND_I_SET));
	send_command(set_Vop(contrast));
}

void PCD_text(const char *text, uint8_t x, uint8_t line){
	send_command(func_set(CHIP_ACTIVE, HORZNTL_ADDR, BASIC_I_SET));
	send_command(set_x_addr(x));
	send_command(set_y_addr(line));
	for(; *text != '\0'; text++){
		for (uint8_t j = 0; j < CHAR_WIDTH; j++)
			send_data(pgm_read_byte(&characters[(uint8_t)(*text) - INDIS_OFFSET][j]));
	}
}

void PCD_clear(uint8_t x1_coor, uint8_t x2_coor, uint8_t y_line){
	send_command(func_set(CHIP_ACTIVE, HORZNTL_ADDR, BASIC_I_SET));
	send_command(set_x_addr(x1_coor));
	send_command(set_y_addr(y_line));
	for (; x1_coor < x2_coor; x1_coor++)
		send_data(0x00);
}
void PCD_clear_all(void){
	send_command(func_set(CHIP_ACTIVE, HORZNTL_ADDR, BASIC_I_SET));
	send_command(set_x_addr(0));
	send_command(set_y_addr(0));
	for (int16_t i = 0; i < 504; i++){
		send_data(0x00);
	}
}
void PCD_invert(void){
	send_command(func_set(CHIP_ACTIVE, HORZNTL_ADDR, BASIC_I_SET));
	send_command(dsply_ctrl(INV_VID_MODE));
}


